<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIå¯†é’¥é…ç½®è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8fafc;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #1e293b;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .warning {
            background: #fefce8;
            color: #ca8a04;
            border: 1px solid #fde68a;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            margin: 10px 0;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #2563eb;
        }
        .test-btn {
            background: #10b981;
        }
        .test-btn:hover {
            background: #059669;
        }
        .clear-btn {
            background: #ef4444;
        }
        .clear-btn:hover {
            background: #dc2626;
        }
        .code {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”‘ APIå¯†é’¥é…ç½®è°ƒè¯•å·¥å…·</h1>
        <p>ç”¨äºè¯Šæ–­å’Œé…ç½®æ™ºè°±AI APIå¯†é’¥é—®é¢˜</p>
    </div>

    <div class="container">
        <h2>ğŸ“‹ å½“å‰çŠ¶æ€æ£€æŸ¥</h2>
        <div id="statusContainer">
            <div class="status warning">æ­£åœ¨æ£€æŸ¥...</div>
        </div>
        <button onclick="checkStatus()" class="test-btn">é‡æ–°æ£€æŸ¥</button>
    </div>

    <div class="container">
        <h2>ğŸ”§ APIå¯†é’¥é…ç½®</h2>
        <p>è¯·è¾“å…¥æ‚¨çš„æ™ºè°±AI APIå¯†é’¥ï¼š</p>
        <input type="text" id="apiKeyInput" placeholder="è¯·è¾“å…¥APIå¯†é’¥ (æ ¼å¼: xxxxxxxx.xxxxxxxxxxxxxxxx)" />
        <br>
        <button onclick="saveApiKey()">ä¿å­˜å¯†é’¥</button>
        <button onclick="testApiKey()" class="test-btn">æµ‹è¯•å¯†é’¥</button>
        <button onclick="clearApiKey()" class="clear-btn">æ¸…é™¤å¯†é’¥</button>
        
        <div class="status warning" style="margin-top: 15px;">
            <strong>æ³¨æ„ï¼š</strong> APIå¯†é’¥å°†ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­ï¼Œä»…åœ¨å½“å‰æµè§ˆå™¨æœ‰æ•ˆã€‚
        </div>
    </div>

    <div class="container">
        <h2>ğŸ§ª APIæµ‹è¯•</h2>
        <button onclick="testEmbedding()" class="test-btn">æµ‹è¯•å‘é‡åŒ–API</button>
        <button onclick="testChat()" class="test-btn">æµ‹è¯•å¯¹è¯API</button>
        <div id="testResults" class="code" style="margin-top: 15px;">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <div class="container">
        <h2>ğŸ“– é…ç½®è¯´æ˜</h2>
        <div class="code">
1. è·å–APIå¯†é’¥ï¼š
   - è®¿é—® https://open.bigmodel.cn/
   - æ³¨å†Œ/ç™»å½•è´¦å·
   - åœ¨æ§åˆ¶å°åˆ›å»ºAPIå¯†é’¥

2. å¯†é’¥æ ¼å¼ï¼š
   - æ ¼å¼ï¼šxxxxxxxx.xxxxxxxxxxxxxxxx
   - ç¤ºä¾‹ï¼š12345678.abcdefghijklmnop

3. ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå¯é€‰ï¼‰ï¼š
   - è®¾ç½® ZHIPU_API_KEY ç¯å¢ƒå˜é‡
   - æˆ–åœ¨ .env æ–‡ä»¶ä¸­æ·»åŠ ï¼šZHIPU_API_KEY=your_key_here

4. æ•…éšœæ’é™¤ï¼š
   - ç¡®ä¿å¯†é’¥æ ¼å¼æ­£ç¡®
   - æ£€æŸ¥è´¦æˆ·ä½™é¢
   - éªŒè¯APIæƒé™
        </div>
    </div>

    <script>
        // æ£€æŸ¥å½“å‰çŠ¶æ€
        async function checkStatus() {
            const container = document.getElementById('statusContainer');
            container.innerHTML = '<div class="status warning">æ­£åœ¨æ£€æŸ¥...</div>';

            const checks = [];

            // æ£€æŸ¥localStorageä¸­çš„APIå¯†é’¥
            const localApiKey = localStorage.getItem('zhipuApiKey');
            if (localApiKey) {
                checks.push(`<div class="status success">âœ… æœ¬åœ°å­˜å‚¨ä¸­æ‰¾åˆ°APIå¯†é’¥ (é•¿åº¦: ${localApiKey.length})</div>`);
                document.getElementById('apiKeyInput').value = localApiKey;
            } else {
                checks.push(`<div class="status error">âŒ æœ¬åœ°å­˜å‚¨ä¸­æœªæ‰¾åˆ°APIå¯†é’¥</div>`);
            }

            // æµ‹è¯•APIè¿æ¥
            try {
                const response = await fetch('/api/zhipu/models', {
                    method: 'GET',
                    headers: {
                        'Authorization': localApiKey ? `Bearer ${localApiKey}` : ''
                    }
                });

                if (response.ok) {
                    checks.push(`<div class="status success">âœ… APIè¿æ¥æ­£å¸¸</div>`);
                } else {
                    const errorText = await response.text();
                    checks.push(`<div class="status error">âŒ APIè¿æ¥å¤±è´¥: ${response.status} - ${errorText}</div>`);
                }
            } catch (error) {
                checks.push(`<div class="status error">âŒ APIè¿æ¥å¼‚å¸¸: ${error.message}</div>`);
            }

            container.innerHTML = checks.join('');
        }

        // ä¿å­˜APIå¯†é’¥
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                alert('è¯·è¾“å…¥APIå¯†é’¥');
                return;
            }

            // éªŒè¯å¯†é’¥æ ¼å¼
            if (!/^[a-zA-Z0-9]+\.[a-zA-Z0-9]+$/.test(apiKey)) {
                alert('APIå¯†é’¥æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºï¼šxxxxxxxx.xxxxxxxxxxxxxxxx');
                return;
            }

            localStorage.setItem('zhipuApiKey', apiKey);
            alert('APIå¯†é’¥å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
            checkStatus();
        }

        // æµ‹è¯•APIå¯†é’¥
        async function testApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                alert('è¯·å…ˆè¾“å…¥APIå¯†é’¥');
                return;
            }

            try {
                const response = await fetch('/api/zhipu/models', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    alert('APIå¯†é’¥æµ‹è¯•æˆåŠŸï¼');
                    console.log('å¯ç”¨æ¨¡å‹:', data);
                } else {
                    const errorText = await response.text();
                    alert(`APIå¯†é’¥æµ‹è¯•å¤±è´¥: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                alert(`APIæµ‹è¯•å¼‚å¸¸: ${error.message}`);
            }
        }

        // æ¸…é™¤APIå¯†é’¥
        function clearApiKey() {
            localStorage.removeItem('zhipuApiKey');
            document.getElementById('apiKeyInput').value = '';
            alert('APIå¯†é’¥å·²æ¸…é™¤');
            checkStatus();
        }

        // æµ‹è¯•å‘é‡åŒ–API
        async function testEmbedding() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.textContent = 'æ­£åœ¨æµ‹è¯•å‘é‡åŒ–API...';

            const apiKey = localStorage.getItem('zhipuApiKey');
            if (!apiKey) {
                resultsDiv.textContent = 'é”™è¯¯: è¯·å…ˆé…ç½®APIå¯†é’¥';
                return;
            }

            try {
                const response = await fetch('/api/zhipu/embeddings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'embedding-3',
                        input: 'æµ‹è¯•æ–‡æœ¬',
                        dimensions: 768
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    resultsDiv.textContent = `å‘é‡åŒ–APIæµ‹è¯•æˆåŠŸï¼\n\nå“åº”æ•°æ®:\n${JSON.stringify(data, null, 2)}`;
                } else {
                    const errorText = await response.text();
                    resultsDiv.textContent = `å‘é‡åŒ–APIæµ‹è¯•å¤±è´¥:\nHTTP ${response.status}\n\né”™è¯¯è¯¦æƒ…:\n${errorText}`;
                }
            } catch (error) {
                resultsDiv.textContent = `å‘é‡åŒ–APIæµ‹è¯•å¼‚å¸¸:\n${error.message}`;
            }
        }

        // æµ‹è¯•å¯¹è¯API
        async function testChat() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.textContent = 'æ­£åœ¨æµ‹è¯•å¯¹è¯API...';

            const apiKey = localStorage.getItem('zhipuApiKey');
            if (!apiKey) {
                resultsDiv.textContent = 'é”™è¯¯: è¯·å…ˆé…ç½®APIå¯†é’¥';
                return;
            }

            try {
                const response = await fetch('/api/zhipu/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'glm-4-flash',
                        messages: [
                            { role: 'user', content: 'ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªAPIæµ‹è¯•' }
                        ],
                        max_tokens: 100
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    resultsDiv.textContent = `å¯¹è¯APIæµ‹è¯•æˆåŠŸï¼\n\nå“åº”æ•°æ®:\n${JSON.stringify(data, null, 2)}`;
                } else {
                    const errorText = await response.text();
                    resultsDiv.textContent = `å¯¹è¯APIæµ‹è¯•å¤±è´¥:\nHTTP ${response.status}\n\né”™è¯¯è¯¦æƒ…:\n${errorText}`;
                }
            } catch (error) {
                resultsDiv.textContent = `å¯¹è¯APIæµ‹è¯•å¼‚å¸¸:\n${error.message}`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.onload = function() {
            checkStatus();
        };
    </script>
</body>
</html>